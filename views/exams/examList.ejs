<%- include('../shared/header') %>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Exam Management</h2>
        </div>
        <% if (user.role === 'teacher') { %>
        <div class="col-auto">
            <a href="/exams/new" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Exam
            </a>
        </div>
        <% } %>
    </div>

    <% if (flashMessage) { %>
        <div class="alert alert-<%= flashMessage.type %> alert-dismissible fade show" role="alert">
            <%= flashMessage.message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="row">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Exam Code</th>
                            <th>Title</th>
                            <th>Teacher</th>
                            <th>Duration (min)</th>
                            <% if (user.role === 'student') { %>
                                <th>Available From</th>
                                <th>Available Until</th>
                                <th>Status</th>
                                <th>Latest Score</th>
                                <th>Attempts Left</th>
                            <% } %>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% exams.forEach(exam => { %>
                            <tr>
                                <td><%= exam.exam_code %></td>
                                <td><%= exam.exam_title %></td>
                                <td><%= exam.teacher_name %></td>
                                <td><%= exam.duration_min %></td>
                                <% if (user.role === 'student') { %>
                                    <td>
                                        <%= new Date(exam.open_at).toLocaleString('en-US', { 
                                            year: 'numeric', 
                                            month: 'short', 
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </td>
                                    <td>
                                        <%= new Date(exam.close_at).toLocaleString('en-US', { 
                                            year: 'numeric', 
                                            month: 'short', 
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        }) %>
                                    </td>
                                    <td>
                                        <span class="badge <%= exam.exam_status === 'Available' ? 'bg-success' : 
                                                              exam.exam_status === 'Completed' ? 'bg-secondary' :
                                                              exam.exam_status === 'In Progress' ? 'bg-warning' :
                                                              exam.exam_status === 'Upcoming' ? 'bg-info' : 'bg-danger' %>">
                                            <%= exam.exam_status %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (exam.total_score !== null) { %>
                                            <%= exam.total_score %>/<%= exam.total_points %>
                                        <% } else { %>
                                            N/A
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (exam.max_attempts) { %>
                                            <%= exam.max_attempts - exam.attempt_count %>/<%= exam.max_attempts %>
                                        <% } else { %>
                                            Unlimited
                                        <% } %>
                                    </td>
                                <% } %>
                                <td>
                                    <div class="btn-group">
                                        <% if (user.role === 'student' && exam.exam_status === 'Available') { %>
                                            <a href="/exams/<%= exam.assignment_id %>/take" class="btn btn-sm btn-primary">
                                                <i class="fas fa-play"></i> Start
                                            </a>
                                        <% } %>
                                        
                                        <% if (user.role === 'teacher') { %>
                                            <a href="/exams/<%= exam.exam_id %>/edit" class="btn btn-sm btn-warning">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <a href="/exams/<%= exam.exam_id %>/assign" class="btn btn-sm btn-info">
                                                <i class="fas fa-users"></i> Assignments
                                            </a>
                                            <button onclick="deleteExam('<%= exam.exam_id %>')" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        <% } %>

                                        <% if (user.role === 'admin') { %>
                                            <button onclick="deleteExam('<%= exam.exam_id %>')" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function deleteExam(examId) {
    if (confirm('Are you sure you want to delete this exam? This action cannot be undone.')) {
        fetch(`/exams/${examId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show updated list
                window.location.reload();
            } else {
                alert(data.message || 'Error deleting exam');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting exam');
        });
    }
}
</script>

<%- include('../shared/footer') %>