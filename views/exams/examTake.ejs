<%- include('../shared/header') %>

<div class="container mt-4" id="examContainer">
    <div class="row mb-3">
        <div class="col">
            <h2><%= exam.exam_title %></h2>
            <p class="text-muted">Exam Code: <%= exam.exam_code %></p>
        </div>
        <div class="col-auto">
            <div class="timer-container">
                <h4 class="text-danger">Time Remaining: <span id="timer"></span></h4>
            </div>
        </div>
    </div>

    <div class="alert alert-warning" role="alert">
        Do not refresh or close the page. Your progress is automatically saved.
    </div>

    <script>
        // Initialize timer
        const startTime = new Date().getTime();
        const duration = <%= exam.duration_min %> * 60 * 1000; // Convert minutes to milliseconds
        const endTime = startTime + duration;

        function updateTimer() {
            const now = new Date().getTime();
            const timeLeft = endTime - now;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').textContent = '00:00';
                submitExam(true); // Auto submit when time runs out
                return;
            }

            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            document.getElementById('timer').textContent = 
                minutes.toString().padStart(2, '0') + ':' + 
                seconds.toString().padStart(2, '0');
        }

        const timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Initial update
    </script>

    <form id="examForm" class="needs-validation" novalidate>
        <input type="hidden" id="attemptId" value="<%= attemptId %>">
        
        <div id="questionContainer">
            <% questions.forEach((question, index) => { %>
                <div class="card mb-4 question-card" data-question-id="<%= question.question_id %>">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Question <%= index + 1 %></h5>
                        <span class="badge bg-primary"><%= question.points %> points</span>
                    </div>
                    <div class="card-body">
                        <p class="question-text"><%= question.body_text %></p>
                        
                        <% if (question.media && question.media.length > 0) { %>
                            <div class="question-media mb-3">
                                <% question.media.forEach(media => { %>
                                    <% if (media.file_url.match(/\.(jpg|jpeg|png|gif)$/i)) { %>
                                        <img src="/<%= media.file_url %>" class="img-fluid mb-2" alt="Question Image">
                                    <% } %>
                                <% }) %>
                            </div>
                        <% } %>

                        <div class="answer-section">
                            <% if (question.type_name === 'Câu hỏi trắc nghiệm' && question.options) { %>
                                <div class="mcq-options">
                                    <% question.options.forEach((option, optIndex) => { %>
                                        <div class="form-check mb-2">
                                            <input 
                                                class="form-check-input" 
                                                type="radio"
                                                name="question_<%= question.question_id %>" 
                                                id="option_<%= option.option_id %>"
                                                value="<%= option.option_id %>"
                                                data-question-id="<%= question.question_id %>"
                                                <% if (question.response && question.response.some(r => r.selected_option_id === option.option_id)) { %>checked<% } %>
                                            >
                                            <label class="form-check-label" for="option_<%= option.option_id %>">
                                                <%= String.fromCharCode(65 + optIndex) %>. <%= option.option_text %>
                                            </label>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else if (question.type_code === 'ESSAY') { %>
                                <div class="form-group">
                                    <textarea 
                                        class="form-control answer-text" 
                                        rows="5" 
                                        data-question-id="<%= question.question_id %>"
                                        placeholder="Enter your answer here..."
                                    ></textarea>
                                </div>
                                <div class="mt-3">
                                    <input type="file" 
                                        class="form-control answer-file" 
                                        data-question-id="<%= question.question_id %>"
                                        multiple
                                        accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png"
                                    >
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>

        <div class="text-center mt-4 mb-5">
            <button type="submit" class="btn btn-primary btn-lg" >Submit Exam</button>
        </div>
    </form>
</div>


<script>
async function submitExam(isAutoSubmit = false) {
    try {
        const form = document.getElementById('examForm');
        const responses = {};

        // Gather MCQ responses
        document.querySelectorAll('.form-check-input:checked').forEach(radio => {
            const questionId = radio.getAttribute('data-question-id');
            responses[questionId] = {
                selectedOptionId: parseInt(radio.value)
            };
        });

        // Gather essay responses
        document.querySelectorAll('.answer-text').forEach(textarea => {
            const questionId = textarea.getAttribute('data-question-id');
            if (textarea.value.trim()) {
                responses[questionId] = {
                    text: textarea.value.trim()
                };
            }
        });

        // Create form data for submission
        const formData = new FormData();
        formData.append('responses', JSON.stringify(responses));
        formData.append('isAutoSubmit', isAutoSubmit.toString());

        // Add essay question files if any
        document.querySelectorAll('.answer-file').forEach(fileInput => {
            const questionId = fileInput.getAttribute('data-question-id');
            if (fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach(file => {
                    formData.append(`files_${questionId}`, file);
                });
            }
        });

        const attemptId = document.getElementById('attemptId').value;
        const response = await fetch(`/exams/submit/${attemptId}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Mark the form as submitted
            document.getElementById('examForm').classList.add('submitted');
            alert(result.message);
            // Redirect to the assignments page
            window.location.href = '/exams';
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error submitting exam:', error);
        alert('Error submitting exam. Please try again.');
    }
}

// Handle form submission
document.getElementById('examForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (confirm('Are you sure you want to submit this exam? This action cannot be undone.')) {
        await submitExam(false);
    }
});

// Warn user before leaving page
window.addEventListener('beforeunload', (e) => {
    if (!document.getElementById('examForm').classList.contains('submitted')) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>

<%- include('../shared/footer') %>